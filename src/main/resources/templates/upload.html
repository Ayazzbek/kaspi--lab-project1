<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout :: head"></head>
<body>
<div th:replace="layout :: body">
    <div th:fragment="content">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title mb-4">
                            <i class="bi bi-upload me-2"></i>
                            Загрузка файла
                        </h3>

                        <!-- Форма загрузки -->
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="clientId" class="form-label">
                                    <i class="bi bi-person-badge me-2"></i>
                                    Client ID *
                                </label>
                                <input type="text" class="form-control" id="clientId"
                                       placeholder="my-app" required>
                                <div class="form-text">
                                    Идентификатор вашего приложения (макс. 100 символов)
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="uploadId" class="form-label">
                                    <i class="bi bi-hash me-2"></i>
                                    Upload ID *
                                </label>
                                <input type="text" class="form-control" id="uploadId"
                                       placeholder="doc-001" required>
                                <div class="form-text">
                                    Уникальный ID для идемпотентности (макс. 200 символов)<br>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                            onclick="generateUploadId()">
                                        <i class="bi bi-dice-5"></i> Сгенерировать
                                    </button>
                                </div>
                            </div>

                            <!-- Область перетаскивания файла -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="bi bi-file-earmark me-2"></i>
                                    Файл *
                                </label>
                                <div class="upload-area" id="dropArea"
                                     onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #007bff;"></i>
                                    <h5 class="mt-3">Перетащите файл сюда</h5>
                                    <p class="text-muted">или нажмите для выбора</p>
                                    <p class="small text-muted">
                                        Максимальный размер: <span th:text="${maxFileSize}">100MB</span><br>
                                        Поддерживаемые типы: изображения, PDF, текст, ZIP
                                    </p>
                                </div>
                                <input type="file" class="form-control d-none" id="fileInput"
                                       onchange="handleFileSelect(this.files[0])">

                                <!-- Информация о выбранном файле -->
                                <div id="fileInfo" class="file-info d-none">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong id="fileName"></strong><br>
                                            <small class="text-muted">
                                                Размер: <span id="fileSize"></span> |
                                                Тип: <span id="fileType"></span>
                                            </small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                onclick="clearFile()">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Дополнительные параметры -->
                            <div class="accordion mb-4" id="advancedOptions">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#collapseAdvanced">
                                            <i class="bi bi-gear me-2"></i>
                                            Дополнительные параметры
                                        </button>
                                    </h2>
                                    <div id="collapseAdvanced" class="accordion-collapse collapse"
                                         data-bs-parent="#advancedOptions">
                                        <div class="accordion-body">
                                            <div class="mb-3">
                                                <label for="timeoutSeconds" class="form-label">
                                                    Таймаут обработки (секунды)
                                                </label>
                                                <input type="number" class="form-control" id="timeoutSeconds"
                                                       value="300" min="30" max="3600">
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Метаданные</label>
                                                <div id="metadataFields">
                                                    <!-- Поля метаданных будут добавляться здесь -->
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                                        onclick="addMetadataField()">
                                                    <i class="bi bi-plus-circle"></i> Добавить поле
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Кнопки -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary me-md-2"
                                        onclick="resetForm()">
                                    <i class="bi bi-arrow-clockwise"></i> Сбросить
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="bi bi-cloud-upload me-2"></i>
                                    Начать загрузку
                                </button>
                            </div>
                        </form>

                        <!-- Прогресс загрузки -->
                        <div id="progressSection" class="mt-4 d-none">
                            <h5 class="mb-3">Прогресс загрузки</h5>
                            <div class="progress progress-bar-custom mb-3">
                                <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="progressDetails"></div>

                            <div id="resultSection" class="d-none">
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Результат загрузки</h5>
                                        <pre id="resultJson" class="bg-light p-3 rounded"></pre>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-outline-secondary"
                                                    onclick="copyResult()">
                                                <i class="bi bi-clipboard"></i> Копировать результат
                                            </button>
                                            <a id="statusLink" href="#" class="btn btn-sm btn-info ms-2">
                                                <i class="bi bi-eye"></i> Просмотреть статус
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Скрипты -->
    <div th:fragment="scripts">
        <script>
            let selectedFile = null;

            // Генерация Upload ID
            function generateUploadId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 8);
                document.getElementById('uploadId').value = `upload-${timestamp}-${random}`;
            }

            // Обработка выбора файла
            function handleFileSelect(file) {
                if (!file) return;

                selectedFile = file;

                // Показываем информацию о файле
                document.getElementById('fileInfo').classList.remove('d-none');
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileType').textContent = file.type || 'unknown';

                // Проверяем размер файла
                const maxSize = 100 * 1024 * 1024; // 100MB
                if (file.size > maxSize) {
                    showAlert('Файл слишком большой! Максимальный размер: 100MB', 'danger');
                    clearFile();
                }
            }

            // Очистка выбранного файла
            function clearFile() {
                selectedFile = null;
                document.getElementById('fileInput').value = '';
                document.getElementById('fileInfo').classList.add('d-none');
            }

            // Сброс формы
            function resetForm() {
                document.getElementById('uploadForm').reset();
                clearFile();
                document.getElementById('progressSection').classList.add('d-none');
                document.getElementById('resultSection').classList.add('d-none');
                document.getElementById('metadataFields').innerHTML = '';
                showAlert('Форма сброшена', 'info');
            }

            // Добавление поля метаданных
            function addMetadataField(key = '', value = '') {
                const fieldId = 'metadata_' + Date.now();
                const html = `
                        <div class="input-group mb-2" id="${fieldId}">
                            <input type="text" class="form-control" placeholder="Ключ" value="${key}">
                            <input type="text" class="form-control" placeholder="Значение" value="${value}">
                            <button class="btn btn-outline-danger" type="button"
                                    onclick="document.getElementById('${fieldId}').remove()">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                document.getElementById('metadataFields').insertAdjacentHTML('beforeend', html);
            }

            // Обработка отправки формы
            document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                // Валидация
                const clientId = document.getElementById('clientId').value.trim();
                const uploadId = document.getElementById('uploadId').value.trim();

                if (!clientId || !uploadId || !selectedFile) {
                    showAlert('Заполните все обязательные поля', 'warning');
                    return;
                }

                // Показываем прогресс
                document.getElementById('progressSection').classList.remove('d-none');
                document.getElementById('resultSection').classList.add('d-none');
                updateProgress(0, 'Подготовка...');

                // Собираем метаданные
                const metadata = {};
                document.querySelectorAll('#metadataFields .input-group').forEach(group => {
                    const inputs = group.querySelectorAll('input');
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        metadata[key] = value;
                    }
                });

                // Создаем FormData
                const formData = new FormData();
                formData.append('clientId', clientId);
                formData.append('uploadId', uploadId);
                formData.append('file', selectedFile);
                formData.append('timeoutSeconds', document.getElementById('timeoutSeconds').value || 300);

                // Добавляем метаданные
                Object.keys(metadata).forEach(key => {
                    formData.append('metadata', JSON.stringify(metadata));
                });

                try {
                    updateProgress(10, 'Отправка запроса...');

                    // Отправляем запрос
                    const response = await fetch('/api/v1/files/upload', {
                        method: 'POST',
                        body: formData
                    });

                    updateProgress(50, 'Обработка на сервере...');

                    const result = await response.json();

                    if (response.ok || response.status === 202) {
                        updateProgress(100, 'Запрос принят в обработку!');
                        showResult(result);

                        // Создаем ссылку для просмотра статуса
                        if (result.uploadRequestId) {
                            const statusUrl = `/status/${result.uploadRequestId}?clientId=${encodeURIComponent(clientId)}`;
                            document.getElementById('statusLink').href = statusUrl;
                        }
                    } else {
                        throw new Error(result.message || 'Ошибка загрузки');
                    }

                } catch (error) {
                    updateProgress(0, 'Ошибка!');
                    showAlert('Ошибка загрузки: ' + error.message, 'danger');
                    console.error('Upload error:', error);
                }
            });

            // Обновление прогресса
            function updateProgress(percent, message) {
                const progressBar = document.getElementById('uploadProgress');
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
                progressBar.setAttribute('aria-valuenow', percent);

                document.getElementById('progressDetails').innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span>${message}</span>
                            <span>${percent}%</span>
                        </div>
                    `;
            }

            // Показ результата
            function showResult(result) {
                document.getElementById('resultJson').textContent =
                    JSON.stringify(result, null, 2);
                document.getElementById('resultSection').classList.remove('d-none');

                // Прокручиваем к результату
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            }

            // Копирование результата
            function copyResult() {
                const resultText = document.getElementById('resultJson').textContent;
                copyToClipboard(resultText);
            }

            // Обработка перетаскивания файлов
            const dropArea = document.getElementById('dropArea');

            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#0056b3';
                dropArea.style.transform = 'scale(1.02)';
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.style.borderColor = '#007bff';
                dropArea.style.transform = 'scale(1)';
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#007bff';
                dropArea.style.transform = 'scale(1)';

                if (e.dataTransfer.files.length) {
                    handleFileSelect(e.dataTransfer.files[0]);
                }
            });

            // Инициализация
            document.addEventListener('DOMContentLoaded', function() {
                // Добавляем пример метаданных
                addMetadataField('author', 'Ваше имя');
                addMetadataField('description', 'Описание файла');

                // Генерируем начальный Upload ID
                generateUploadId();
            });
        </script>
    </div>
</div>
</body>
</html>